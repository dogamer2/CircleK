<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>

<style>
  body { font-family:"Poppins",sans-serif; background:#f5f5f5; padding:20px; color:#333; }
  h1 { text-align:center; margin-bottom:25px; }
  section { background:white; padding:20px; border-radius:12px; margin-bottom:25px; box-shadow:0 5px 20px rgba(0,0,0,0.1); }
  button { padding:10px 15px; border:none; border-radius:8px; cursor:pointer; font-weight:600; background:#c8252b; color:white; margin-top:10px; }
  button:hover { background:#a61b22; }
  input, select { padding:6px 10px; border-radius:6px; border:1px solid #aaa; margin:3px 0; }
  input[type="number"] { width:80px; }
  .item-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:8px 0; border-bottom:1px solid #eee; }
  .item-controls button { margin-left:5px; background:#444; }
  .item-controls button.delete { background:#b00000; }
</style>
</head>

<body>

<h1>Admin Panel</h1>

<!-- ACCESS CODES SECTION -->
<section>
  <h2>Access Codes</h2>
  <div class="codes" id="codes"></div>
  <button id="newCode">Generate New Code</button>
</section>

<!-- PRODUCT LIST + EDIT SECTION -->
<section>
  <h2>Items</h2>
  <div id="products"></div>
  <button id="refreshProducts">Refresh List</button>
</section>

<!-- ADD NEW PRODUCT -->
<section>
  <h2>Add New Item</h2>

  <label>Name:</label><br>
  <input id="new-name" placeholder="Chips"><br>

  <label>Subtitle:</label><br>
  <input id="new-subtitle" placeholder="(Any flavour, 66g)"><br>

  <label>Price:</label><br>
  <input id="new-price" type="number" step="0.01"><br>

  <label>Image filename:</label><br>
  <input id="new-image" placeholder="chips.png"><br>

  <label>Barcode filename:</label><br>
  <input id="new-barcode" placeholder="chips_barcode.png"><br>

  <label>Select product image (from /productimages)</label><br>
  <select id="image-select"></select><br>

  <label>Select barcode (from /barcodes)</label><br>
  <select id="barcode-select"></select><br>

  <button id="addProduct">Add Product</button>
  </section>

<script type="module">
import { supabase, generateCode } from './supabase.js';

/* -----------------------------
   ADMIN LOGIN
------------------------------ */
const password = prompt("Enter admin password:");
if (!password || password !== "3723") {
  document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;'>Access Denied</h2>";
  throw new Error("Access denied");
}

/* -----------------------------
   ACCESS CODES
------------------------------ */
async function loadCodes() {
  const { data, error } = await supabase.from('access_codes')
    .select('*')
    .order('created_at', { ascending: false });

  const container = document.getElementById('codes');
  if (error) {
    container.innerHTML = "<div style='color:red'>Error loading codes</div>";
    return;
  }

  async function loadFileLists() {
  // Load product images
  const { data: imgFiles } = await supabase.storage.from('productimages').list();
  const imgSelect = document.getElementById("image-select");

  imgSelect.innerHTML = imgFiles
    .map(f => `<option value="${f.name}">${f.name}</option>`)
    .join('');

  // Load barcodes
  const { data: barFiles } = await supabase.storage.from('barcodes').list();
  const barSelect = document.getElementById("barcode-select");

  barSelect.innerHTML = barFiles
    .map(f => `<option value="${f.name}">${f.name}</option>`)
    .join('');

  // Autofill the text boxes with selected values
  imgSelect.onchange = () => {
    document.getElementById("new-image").value = imgSelect.value;
  };

  barSelect.onchange = () => {
    document.getElementById("new-barcode").value = barSelect.value;
  };
}

loadFileLists();


  container.innerHTML = data.map(c =>
    `<div>${c.code} â€” ${c.used ? 'USED' : 'UNUSED'}</div>`
  ).join('');
}

document.getElementById("newCode").onclick = async () => {
  const code = crypto.randomUUID().slice(0,8).toUpperCase();
  await generateCode(code);
  loadCodes();
};

loadCodes();

/* -----------------------------
   PRODUCTS
------------------------------ */
async function loadProducts() {
  const container = document.getElementById('products');
  container.innerHTML = "Loading...";

  const { data, error } = await supabase.from('products')
    .select('*')
    .order('name', { ascending: true });

  if (error) {
    container.innerHTML = "<div style='color:red'>Error loading products</div>";
    return;
  }

  container.innerHTML = "";

  data.forEach(item => {
    const row = document.createElement("div");
    row.className = "item-row";

    row.innerHTML = `
      <div>
        <b>${item.name}</b><br>
        <small>${item.subtitle || ""}</small><br>
        <small>UPC: ${item.upc || "n/a"}</small>
      </div>

      <div class="item-controls">
        <input type="number" step="0.01" value="${item.price}">
        <button class="update">Update</button>
        <button class="delete">Delete</button>
      </div>
    `;

    const priceInput = row.querySelector("input");
    const updateBtn = row.querySelector(".update");
    const deleteBtn = row.querySelector(".delete");

    updateBtn.onclick = async () => {
      const newPrice = parseFloat(priceInput.value);
      if (isNaN(newPrice)) return alert("Invalid price");

      const { error } = await supabase.from("products")
        .update({ 
          price: newPrice,
          updated_at: new Date().toISOString()
        })
        .eq("id", item.id);

      if (error) return alert("Error updating");
      alert("Updated!");
    };

    deleteBtn.onclick = async () => {
      if (!confirm(`Delete ${item.name}?`)) return;

      await supabase.from("products").delete().eq("id", item.id);
      loadProducts();
    };

    container.appendChild(row);
  });
}

document.getElementById("refreshProducts").onclick = loadProducts;
loadProducts();

/* -----------------------------
   ADD PRODUCT
------------------------------ */
document.getElementById("addProduct").onclick = async () => {
  const name = document.getElementById("new-name").value.trim();
  const subtitle = document.getElementById("new-subtitle").value.trim() || null;
  const price = parseFloat(document.getElementById("new-price").value);
  const image = document.getElementById("new-image").value.trim();
  const barcode = document.getElementById("new-barcode").value.trim();

  if (!name || isNaN(price) || !image || !barcode) {
    return alert("Missing fields.");
  }

  const upc = String(Math.floor(Math.random()*1e12)).padStart(12,"0");

  const { error } = await supabase.from("products").insert({
    name,
    subtitle,
    price,
    image: image,
    barcode: barcode,
    upc,
    created_at: new Date().toISOString()
  });

  if (error) return alert("Error adding product");

  alert("Product Added!");
  loadProducts();
};
</script>

</body>
</html>
