<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>

<style>
  body { font-family:"Poppins",sans-serif; background:#f5f5f5; padding:20px; color:#333; }
  h1 { text-align:center; margin-bottom:25px; }
  section { background:white; padding:20px; border-radius:12px; margin-bottom:25px; box-shadow:0 5px 20px rgba(0,0,0,0.1); }
  button { padding:10px 15px; border:none; border-radius:8px; cursor:pointer; font-weight:600; background:#c8252b; color:white; margin-top:10px; }
  button:hover { background:#a61b22; }
  input { padding:8px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px; width:100%; }
  .item-row { display:flex; justify-content:space-between; margin-bottom:10px; align-items:center; }
  .delete-btn { background:#444; margin-left:8px; }
  .delete-btn:hover { background:#222; }
</style>

</head>

<body>
<h1>Admin Panel</h1>

<!-- ACCESS CODES -->
<section>
  <h2>Access Codes</h2>
  <div id="codes"></div>
  <button id="newCode">Generate New Code</button>
</section>

<!-- PRODUCTS -->
<section>
  <h2>Products</h2>
  <div id="products"></div>
  <button id="refreshProducts">Refresh</button>
</section>

<!-- ADD PRODUCT -->
<section>
  <h2>Add Product</h2>

  <input id="pname" placeholder="Product Name">
  <input id="pprice" type="number" placeholder="Price" step="0.01">

  <label>Product Image File Name (in /productimages):</label>
  <input id="pimg" placeholder="chips.png">

  <label>Barcode Image File Name (in /barcodes):</label>
  <input id="pbarcode" placeholder="chipsbarcode.png">

  <button id="addProduct">Add Product</button>
</section>

<!-- CONTACT MESSAGES -->
<section>
  <h2>Contact Messages</h2>
  <div id="contacts"></div>
  <button id="refreshContacts">Refresh</button>
</section>

<!-- BUG REPORTS -->
<section>
  <h2>Bug Reports</h2>
  <div id="bugs"></div>
  <button id="refreshBugs">Refresh</button>
</section>

<!-- VISITORS -->
<section>
  <h2>Visitors</h2>
  <div id="visitors"></div>
  <button id="refreshVisitors">Refresh</button>
</section>

<!-- ANALYTICS -->
<section>
  <h2>Analytics</h2>
  <div id="analytics"></div>
  <button id="refreshAnalytics">Refresh</button>
</section>

<script type="module">
import { supabase } from './supabase.js';

/* ---------------- PASSWORD ---------------- */
const pw = prompt("Admin Password:");
if (pw !== "3723") {
    document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;'>Access Denied</h2>";
    throw new Error("Invalid password");
}

/* ---------------- ACCESS CODES ---------------- */
async function loadCodes() {
    const { data } = await supabase.from('access_codes').select('*').order('created_at', { ascending: false });
    document.getElementById("codes").innerHTML =
      data.map(c => `<div>${c.code} — ${c.used ? "USED" : "UNUSED"}</div>`).join("");
}

document.getElementById("newCode").onclick = async () => {
    const code = crypto.randomUUID().slice(0,8).toUpperCase();
    await supabase.from('access_codes').insert([{ code }]);
    loadCodes();
};

loadCodes();

/* ---------------- PRODUCTS ---------------- */
async function loadProducts() {
    const container = document.getElementById("products");
    const { data } = await supabase.from('products').select('*').order('name');

    container.innerHTML = "";

    data.forEach(item => {
        const row = document.createElement("div");
        row.className = "item-row";

        row.innerHTML = `
            <strong>${item.name}</strong>
            <div>
                $<input id="price-${item.id}" type="number" value="${item.price}" step="0.01" style="width:80px;">
                <button onclick="updatePrice(${item.id})">Update</button>
                <button class="delete-btn" onclick="deleteProduct(${item.id})">Delete</button>
            </div>
        `;

        container.appendChild(row);
    });
}
window.updatePrice = async (id) => {
    const price = parseFloat(document.getElementById(`price-${id}`).value);
    await supabase.from('products').update({ price }).eq('id', id);
    alert("Updated!");
};
window.deleteProduct = async (id) => {
    await supabase.from('products').delete().eq('id', id);
    loadProducts();
};

document.getElementById("refreshProducts").onclick = loadProducts;
loadProducts();

/* ---------------- ADD PRODUCT ---------------- */
document.getElementById("addProduct").onclick = async () => {
    const name = document.getElementById("pname").value.trim();
    const price = parseFloat(document.getElementById("pprice").value);
    const img = document.getElementById("pimg").value.trim();
    const barcode = document.getElementById("pbarcode").value.trim();

    if (!name || !price || !img || !barcode) return alert("Missing fields");

    const upc = String(Math.floor(Math.random() * 9_999_999_999_999)).padStart(12, "0");

    await supabase.from("products").insert([{ 
        name, price, upc,
        image: img,
        barcode: barcode
    }]);

    alert("Product added. Remember to manually upload the images.");
    loadProducts();
};

/* ---------------- CONTACT MESSAGES ---------------- */
async function loadContacts() {
    const { data } = await supabase.from('contact_messages').select('*').order('created_at', { ascending: false });
    document.getElementById("contacts").innerHTML =
      data.map(m => `<div><b>${m.name}</b>: ${m.message}<br><small>${m.email || ""} ${m.phone || ""}</small></div><hr>`).join("");
}
document.getElementById("refreshContacts").onclick = loadContacts;
loadContacts();

/* ---------------- BUG REPORTS ---------------- */
async function loadBugs() {
    const { data } = await supabase.from('bug_reports').select('*').order('created_at');
    document.getElementById("bugs").innerHTML =
      data.map(b => `<div>${b.message}</div><hr>`).join("");
}
document.getElementById("refreshBugs").onclick = loadBugs;
loadBugs();

/* ---------------- VISITORS ---------------- */
async function loadVisitors() {
    const { data } = await supabase.from('visitors').select('*').order('visited_at', { ascending: false });
    document.getElementById("visitors").innerHTML =
      data.map(v => `<div>${v.ip} — ${v.visited_at}</div>`).join("");
}
document.getElementById("refreshVisitors").onclick = loadVisitors;
loadVisitors();

/* ---------------- ANALYTICS ---------------- */
async function loadAnalytics() {
    const { data: redemptions } = await supabase.rpc('count_redemptions');
    document.getElementById("analytics").innerHTML = `
      <div>Total Redemptions: ${redemptions || 0}</div>
    `;
}
document.getElementById("refreshAnalytics").onclick = loadAnalytics;
loadAnalytics();

</script>
</body>
</html>
