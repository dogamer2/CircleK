<!doctype html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Redeemed Prize</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* Your previous CSS here (unchanged) */
</style>
</head>
<body>
<header>
    <button class="menu-btn" aria-label="menu"><span></span></button>
    <a href="index.html" class="logo"><img src="productimages/k.png" alt="Circle K logo"></a>
    <div class="coins" aria-label="Grand Prize Entries">
        <div class="badge" aria-hidden="true">üéÅ</div>
        <div style="display:flex;flex-direction:column;align-items:flex-start;">
            <div class="label">Grand Prize Entries</div>
            <div class="value">187</div>
        </div>
    </div>
</header>
<a class="close-btn" href="index.html" aria-label="Close">√ó</a>

<main>
    <section class="hero">
        <div class="plate-area">
            <div class="product-title" id="product-title"></div>
            <div class="product-sub" id="product-sub"></div>
            <div class="scene">
                <div class="badge-left" aria-hidden="true"></div>
                <div class="badge-right" aria-hidden="true"></div>
                <img class="product-img" id="product-img" src="" alt="">
            </div>
        </div>
    </section>

```
<section class="barcode-card" aria-live="polite">
    <h3>REDEEMED AT:</h3>
    <div class="redeemed-time" id="redeemed-at">--:-- - --.--.--</div>
    <div class="timer-badge" id="timer-badge">05:00</div>
    <img id="barcode-img" class="barcode-img" src="" alt="Barcode">
    <div class="code-text" id="code-text">000000000000</div>
</section>
```

</main>

<script type="module">
import { supabase, addToTotal } from './supabase.js';

const params = new URLSearchParams(window.location.search);
const product = (params.get('product') || 'chips').toLowerCase();
const title = params.get('title') || 'Free Circle K Chips';
const sub = params.get('sub') || '(Any flavour, 66 g)';
const img = params.get('img') || 'productimages/chips.png';

// Update UI
document.getElementById('product-title').textContent = title;
document.getElementById('product-sub').textContent = sub;
const productImg = document.getElementById('product-img');
productImg.src = img;
productImg.alt = title;

// Redeemed time
const redeemedEl = document.getElementById('redeemed-at');
redeemedEl.textContent = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}) + ' - ' +
                        new Date().toLocaleDateString('en-GB');

// Countdown timer
const badge = document.getElementById('timer-badge');
const endTime = Date.now() + 5*60*1000;
function tickBadge() {
    const t = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
    const m = Math.floor(t/60), s = t%60;
    badge.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
tickBadge();
setInterval(tickBadge,1000);

// Barcode setup
const productCodes = {
    chips: '078302648190',
    candy: '045678123456',
    alani: '012345678901',
    arizona: '067890123450',
    froster: '089012345678',
    beverage: '023456789012'
};
document.getElementById('code-text').textContent = productCodes[product] || '000000000000';

const barcodeImg = document.getElementById('barcode-img');
barcodeImg.src = `barcodes/${product}barcode.png`;
barcodeImg.alt = `${title} barcode`;
barcodeImg.onerror = () => { barcodeImg.style.display='none'; };

// Redeem item using Supabase price
async function redeemItem(prod) {
    try {
        const { data, error } = await supabase
            .from('products')
            .select('price')
            .eq('name', prod)
            .single();
        if (error || !data) throw error || new Error('No price data');
        const price = data.price;

        // Add to total in Supabase
        await addToTotal(price);

        // LocalStorage fallback
        const key = `redemptionCount_${prod}`;
        const count = parseInt(localStorage.getItem(key) || '0') + 1;
        localStorage.setItem(key, count);
        console.log('Redeemed:', prod, 'Price:', price, 'Count:', count);

    } catch(err) {
        console.error('Redeem failed:', err);
    }
}

redeemItem(product);
</script>

</body>
</html>
