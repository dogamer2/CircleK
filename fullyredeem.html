<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Redeem Item</title>
  

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Poppins", sans-serif;
      background: #f5f5f5;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }

    h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .item-card {
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .price {
      font-size: 32px;
      font-weight: 800;
      margin: 10px 0 20px;
    }

    button {
      padding: 14px 24px;
      background: #ff3c00;
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
    }

    button:active {
      transform: scale(0.97);
    }
  </style>

  <!-- Supabase handler -->
  <script type="module" src="supabase.js"></script>
  <script>
if (!localStorage.getItem('authCodeValid')) {
  window.location.href = "/login.html";
}
</script>

</head>
<body>
  <div class="container">
    <h1 id="title">Redeem Item</h1>

    <div class="item-card">
      <img id="itemImg" src="productimages/chips.png" alt="Item" style="max-width:220px;margin:0 auto 12px;display:block;">
      <div id="itemName" style="font-weight:800;font-size:18px;margin-bottom:6px;">Free Circle K Chips</div>
      <div id="itemSub" style="color:#666;margin-bottom:12px;">(Any flavour, 66 g)</div>
      <div class="price" id="priceDisplay">$4.99</div>

      <button id="redeemBtn">Redeem Now</button>
    </div>

    <div id="message" style="min-height:28px;margin-top:8px;font-weight:700;"></div>
  </div>
  <script type="module">
    import { addToTotal } from './supabase.js';

    // Read URL params for product/title/price/img
    const params = new URLSearchParams(window.location.search);
    const product = (params.get('product') || 'chips').toLowerCase();
    const title = params.get('title') || 'Free Circle K Chips';
    const sub = params.get('sub') || '(Any flavour, 66 g)';
    const img = params.get('img') || 'productimages/chips.png';
    const priceFromParams = parseFloat(params.get('price'));
    
    // Price mapping (default fallbacks)
    const prices = {
      chips: 4.99,
      candy: 3.49,
      alani: 5.99,
      arizona: 2.99,
      froster: 3.99,
      beverage: 2.49
    };

    // Resolve price
    const price = Number.isFinite(priceFromParams) ? priceFromParams : (prices[product] || 0);

    // Wire UI
    document.getElementById('title').textContent = title;
    document.getElementById('itemName').textContent = title;
    document.getElementById('itemSub').textContent = sub;
    document.getElementById('itemImg').src = img;
    document.getElementById('priceDisplay').textContent = `$${price.toFixed(2)}`;

    const redeemBtn = document.getElementById('redeemBtn');
    const messageEl = document.getElementById('message');

    function showMsg(text, color = '#000') {
      messageEl.textContent = text;
      messageEl.style.color = color;
    }

    // Notify parent windows (index) of redemption
    function notifyParent(amount, productName) {
      const payload = {
        type: 'redeemItem',
        amount: Number(amount),
        product: productName
      };

      try {
        // If opened as popup
        if (window.opener && !window.opener.closed) {
          window.opener.postMessage(payload, '*');
        }
        // If embedded in an iframe or parent window
        if (window.parent && window.parent !== window) {
          window.parent.postMessage(payload, '*');
        }
        // Also post to top just in case
        if (window.top && window.top !== window) {
          window.top.postMessage(payload, '*');
        }
      } catch (err) {
        console.warn('Failed to notify parent windows:', err);
      }
    }

    // Redeem handler (Supabase update)
    async function handleRedeem() {
      redeemBtn.disabled = true;
      redeemBtn.textContent = 'Processing...';
      showMsg('Processing redemption...', '#333');

      try {
        // Try to add to Supabase totals
        const newTotal = await addToTotal(price);

        // Update local fallback
        localStorage.setItem('totalSavedFallback', String(newTotal));

        // UI success
        showMsg('✓ Redeemed! You can use this at checkout.', '#117a37');
        redeemBtn.textContent = 'Redeemed ✓';

        // Notify parent so index updates immediately
        notifyParent(price, product);

        // Optionally close window after a short delay if opened as popup
        setTimeout(() => {
          // if this window was opened by another window, close it
          if (window.opener && !window.opener.closed) {
            window.close();
          }
        }, 1200);
      } catch (err) {
        console.error('Redemption failed (Supabase):', err);
        // fallback to localStorage increment (keeps UI usable offline)
        try {
          const redemptionKey = `redemptionCount_${product}`;
          const currentCount = parseInt(localStorage.getItem(redemptionKey) || '0', 10);
          const newCount = currentCount + 1;
          localStorage.setItem(redemptionKey, String(newCount));

          // update fallback total
          const localTotal = Number(localStorage.getItem('totalSavedFallback') || '0') + price;
          localStorage.setItem('totalSavedFallback', String(localTotal));

          showMsg('Saved locally (offline mode).', '#a66300');
          redeemBtn.textContent = 'Redeemed (offline)';

          // Notify parent so index can update from fallback
          notifyParent(price, product);

          setTimeout(() => {
            if (window.opener && !window.opener.closed) window.close();
          }, 1200);
        } catch (fallbackErr) {
          console.error('Fallback redemption failed:', fallbackErr);
          showMsg('Failed to redeem. Try again.', '#b00020');
          redeemBtn.disabled = false;
          redeemBtn.textContent = 'Redeem Now';
        }
      }
    }

    redeemBtn.addEventListener('click', handleRedeem);

    // Auto-run redemption if ?autoclaim=1 present (optional)
    if (params.get('autoclaim') === '1') {
      setTimeout(handleRedeem, 300);
    }
  </script>
</body>
</html>
