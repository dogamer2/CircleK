<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redeemed Prize</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --red:#b81618;
      --deep-red:#8f0e12;
      --card:#f5ebe2;
      --cream:#f7edde;
      --shadow:0 16px 36px rgba(0,0,0,0.28);
    }
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;min-height:100%;}
    body{
      font-family:'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background:radial-gradient(120% 120% at 50% 20%, #c8252b 0%, #a61215 45%, #8d0b11 100%);
      color:#fff;
      -webkit-font-smoothing:antialiased;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
      padding-bottom:40px;
    }
    header{
      width:100%;
      max-width:520px;
      padding:14px 16px 6px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:relative;
      z-index:2;
    }
    .menu-btn{background:transparent;border:0;display:flex;align-items:center;justify-content:center;padding:10px;cursor:pointer;}
    .menu-btn span,.menu-btn span::before,.menu-btn span::after{display:block;width:30px;height:3px;background:#fff;border-radius:2px;position:relative;box-shadow:0 2px 8px rgba(0,0,0,0.35);}
    .menu-btn span::before,.menu-btn span::after{content:'';position:absolute;left:0;}
    .menu-btn span::before{top:-8px;}
    .menu-btn span::after{top:8px;}
    .logo{display:flex;align-items:center;justify-content:center;position:absolute;left:50%;transform:translateX(-50%);}
    .logo img{width:44px;height:auto;object-fit:contain;filter:brightness(0) invert(1);}
    .coins{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 14px;
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,0.16), rgba(255,255,255,0.08));
      backdrop-filter:blur(3px);
      box-shadow:0 8px 18px rgba(0,0,0,0.26);
    }
    .coins .badge{
      width:34px;height:34px;border-radius:17px;
      background:linear-gradient(180deg,#f6c542,#e9a820);
      display:flex;align-items:center;justify-content:center;
      color:#7a4c0a;font-weight:800;font-size:16px;
      box-shadow:0 6px 12px rgba(0,0,0,0.25);
    }
    .coins .value{font-size:20px;font-weight:800;}
    .coins .label{font-size:11px;line-height:1;color:#f9eedd;font-weight:600;}

    .close-btn{
      position:absolute;
      right:16px;
      top:90px;
      width:44px;
      height:44px;
      border-radius:22px;
      background:rgba(255,255,255,0.12);
      border:1px solid rgba(0,0,0,0.05);
      color:#f7f0ed;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      font-weight:700;
      text-decoration:none;
      box-shadow:0 10px 28px rgba(0,0,0,0.32);
      backdrop-filter:blur(3px);
      z-index:3;
      cursor:pointer;
    }

    main{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:18px;
    }
    .hero{
      width:92%;
      max-width:520px;
      background:var(--card);
      border-radius:32px;
      padding:26px 16px 24px 16px;
      box-shadow:var(--shadow);
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .plate-area{
      background:linear-gradient(180deg,#c22027,#a30f13);
      border-radius:28px;
      padding:26px 12px 30px 12px;
      position:relative;
      box-shadow:inset 0 12px 26px rgba(0,0,0,0.18);
    }
    .plate-area::before{
      content:'';
      position:absolute;
      left:-30px;
      top:32%;
      width:118px;
      height:118px;
      border-radius:59px;
      background:inherit;
      z-index:-1;
      box-shadow:inset 0 0 0 6px rgba(255,255,255,0.22);
    }
    .plate-area::after{
      content:'';
      position:absolute;
      right:-30px;
      top:32%;
      width:118px;
      height:118px;
      border-radius:59px;
      background:inherit;
      z-index:-1;
      box-shadow:inset 0 0 0 6px rgba(255,255,255,0.22);
    }
    .product-title{font-size:28px;font-weight:800;margin-top:6px;}
    .product-sub{font-size:15px;font-weight:700;margin-top:2px;color:#f8f4f2;}
    .scene{margin-top:18px;position:relative;display:flex;flex-direction:column;align-items:center;gap:8px;}
    .platform{
      width:240px;
      height:90px;
      background:radial-gradient(120% 100% at 50% 0%, #f3e6da 0%, #e0cfc0 70%, #d4c0b0 100%);
      border-radius:44px;
      box-shadow:0 18px 38px rgba(0,0,0,0.25), inset 0 8px 22px rgba(255,255,255,0.6);
      transform:perspective(800px) rotateX(32deg);
    }
    .trees{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 28px;
      pointer-events:none;
    }
    .tree{width:48px;height:88px;background:linear-gradient(180deg,#a21a1e,#7f0f14);border-radius:28px 28px 12px 12px;filter:drop-shadow(0 10px 16px rgba(0,0,0,0.24));transform:translateY(10px);}
    .tree.small{width:30px;height:64px;opacity:0.9;}
    .product-img{
      width:240px;
      max-width:82%;
      filter:drop-shadow(0 16px 30px rgba(0,0,0,0.35));
      position:relative;
      z-index:2;
    }
    .badge-left,.badge-right{
      position:absolute;
      top:32%;
      width:118px;
      height:118px;
      border-radius:59px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 12px 26px rgba(0,0,0,0.24);
      z-index:2;
    }
    .badge-left{
      left:-30px;
      background:radial-gradient(circle at 30% 30%, #d8363f, #8e0f13);
    }
    .badge-right{
      right:-30px;
      background:radial-gradient(circle at 30% 30%, #3cff86, #0dcf5b);
    }
    .badge-icon{width:46px;height:46px;filter:drop-shadow(0 3px 6px rgba(0,0,0,0.3));}

    .barcode-card{
      width:100%;
      max-width:560px;
      background:#fff;
      color:#2f2f2f;
      border-radius:32px 32px 0 0;
      padding:22px 14px 28px 14px;
      box-shadow:0 -6px 24px rgba(0,0,0,0.18);
      text-align:center;
      margin-top:-10px;
    }
    .barcode-card h3{margin:0 0 10px 0;font-size:18px;color:#767676;letter-spacing:0.6px;}
    .redeemed-time{
      margin:10px auto 12px auto;
      width:88%;
      max-width:460px;
      height:68px;
      border-radius:24px;
      background:#f4f4f4;
      border:1px solid #e5e5e5;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:22px;
      color:#4a4a4a;
      box-shadow:inset 0 1px 6px rgba(0,0,0,0.06);
    }
    .timer-badge{
      width:84px;
      height:84px;
      border-radius:42px;
      margin:0 auto 12px auto;
      border:10px solid #d9d9d9;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      color:#4a4a4a;
      box-shadow:0 6px 16px rgba(0,0,0,0.12);
    }
    .barcode-img{
      width:92%;
      max-width:520px;
      margin:0 auto 8px auto;
      background:#fff;
    }
    .code-text{
      font-weight:800;
      font-size:22px;
      letter-spacing:1px;
      color:#111;
    }

    @keyframes slideIn{
      from{transform:translateX(100%); opacity:0;}
      to{transform:translateX(0); opacity:1;}
    }
  </style>
</head>
<body>
  <header>
    <button class="menu-btn" aria-label="menu"><span></span></button>
    <a href="index.html" class="logo"><img src="productimages/k.png" alt="Circle K logo"></a>
    <div class="coins" aria-label="Grand Prize Entries">
      <div class="badge" aria-hidden="true">üéÅ</div>
      <div style="display:flex;flex-direction:column;align-items:flex-start;">
        <div class="label">Grand Prize Entries</div>
        <div class="value">187</div>
      </div>
    </div>
  </header>
  <a class="close-btn" href="index.html" aria-label="Close">√ó</a>

  <main>
    <section class="hero">
      <div class="plate-area">
        <div class="product-title" id="product-title">Free Circle K Chips</div>
        <div class="product-sub" id="product-sub">(Any flavour, 66 g)</div>
        <div class="scene">
          <div class="badge-left" aria-hidden="true">
            <svg class="badge-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 14h44v28a8 8 0 0 1-8 8H18a8 8 0 0 1-8-8V14Z" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M44 26H20m10-12v28" stroke="#fff" stroke-width="4" stroke-linecap="round"/></svg>
          </div>
          <div class="badge-right" aria-hidden="true">
            <svg class="badge-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 22h44v26a6 6 0 0 1-6 6H16a6 6 0 0 1-6-6V22Z" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 30h44m-22 0v24" stroke="#fff" stroke-width="4" stroke-linecap="round"/><path d="M32 22c-2.2 0-4-1.8-4-4s1.8-4 4-4c4 0 6 6 6 6s-3.8 2-6 2Zm0 0c2.2 0 4-1.8 4-4s-1.8-4-4-4c-4 0-6 6-6 6s3.8 2 6 2Z" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <img class="product-img" id="product-img" src="productimages/chips.png" alt="Free Circle K Chips">
        </div>
      </div>
    </section>

    <section class="barcode-card" aria-live="polite">
      <h3>REDEEMED AT:</h3>
      <div class="redeemed-time" id="redeemed-at">--:-- - --.--.--</div>
      <div class="timer-badge" id="timer-badge">05:00</div>
      <img id="barcode-img" class="barcode-img" src="barcodes/chipbarcode.png" alt="Barcode">
      <div class="code-text" id="code-text">000000000000</div>
    </section>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const title = params.get('title') || 'Free Circle K Chips';
    const sub = params.get('sub') || '(Any flavour, 66 g)';
    const img = params.get('img') || 'productimages/chips.png';
    const product = (params.get('product') || 'chips').toLowerCase();

    document.getElementById('product-title').textContent = title;
    document.getElementById('product-sub').textContent = sub;
    const productImg = document.getElementById('product-img');
    productImg.src = img;
    productImg.alt = title;

    // Redeemed time formatting
    function formatRedeemed() {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      const month = String(now.getMonth()+1).padStart(2,'0');
      const yy = String(now.getFullYear()).slice(-2);
      return `${hh}:${mm} - ${dd}.${month}.${yy}`;
    }
    document.getElementById('redeemed-at').textContent = formatRedeemed();

    // Countdown badge (start 5 min)
    const badge = document.getElementById('timer-badge');
    const badgeEnd = Date.now() + 5*60*1000;
    function tickBadge(){
      const t = Math.max(0, Math.floor((badgeEnd - Date.now())/1000));
      const m = Math.floor(t/60);
      const s = t % 60;
      badge.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    tickBadge();
    setInterval(tickBadge,1000);

    // Barcode image swap
    const barcodeImg = document.getElementById('barcode-img');
    barcodeImg.src = `barcodes/${product}barcode.png`;
    barcodeImg.alt = `${title} barcode`;
    
    // Handle missing barcode images
    barcodeImg.onerror = function() {
      console.log(`Barcode image not found: ${product}barcode.png`);
      // Try alternative filename or use default
      if (product === 'chips') {
        barcodeImg.src = 'barcodes/chipsbarcode.png';
      } else {
        barcodeImg.style.display = 'none'; // Hide broken image
      }
    };

    // Product barcode mapping
    const productCodes = {
      chips: '078302648190',
      candy: '045678123456', 
      alani: '012345678901',
      arizona: '067890123450',
      froster: '089012345678'
    };

    // Set the barcode code for the current product
    const val = productCodes[product] || '000000000000';
    document.getElementById('code-text').textContent = val;

    // Track redeemed items - try API first, then localStorage
    function trackRedeemedItem(product) {
      console.log('Tracking redeemed item:', product);
      
      // Product prices
      const prices = {
        chips: 4.99,
        candy: 3.49,
        alani: 5.99,
        arizona: 2.99,
        froster: 3.99
      };
      
      const price = prices[product] || 0;
      
      // Try API first
      fetch('/api/add-money', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          product: product,
          price: price
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('Item tracked via API:', product, 'Price:', price);
          console.log('Total saved:', data.totalSaved);
          
          // Show success notification
          showNotification('‚úì Item redeemed successfully!', 'success');
          
          // Notify parent window to update money counter
          if (window.opener) {
            window.opener.postMessage({ 
              type: 'itemRedeemed', 
              product: product,
              totalSaved: data.totalSaved,
              redeemedItems: data.redeemedItems
            }, '*');
          }
        } else {
          throw new Error(data.error || 'API returned error');
        }
      })
      .catch(error => {
        console.log('API not available, using localStorage:', error);
        
        // Fallback to localStorage
        const redemptionKey = `redemptionCount_${product}`;
        const currentCount = parseInt(localStorage.getItem(redemptionKey) || '0');
        const newCount = currentCount + 1;
        
        // Update redemption count
        localStorage.setItem(redemptionKey, newCount.toString());
        
        // Also add to redeemed items list for compatibility
        const redeemedItems = JSON.parse(localStorage.getItem('redeemedItems') || '[]');
        if (!redeemedItems.includes(product)) {
          redeemedItems.push(product);
        }
        localStorage.setItem('redeemedItems', JSON.stringify(redeemedItems));
        
        console.log('Item redeemed via localStorage:', product);
        console.log('Redemption count for', product, ':', newCount);
        console.log('Current redeemed items:', redeemedItems);
        
        // Show fallback notification
        showNotification('‚ö† Item saved locally', 'warning');
        
        // Notify parent window to update money counter
        if (window.opener) {
          window.opener.postMessage({ 
            type: 'itemRedeemed', 
            product: product,
            redeemedItems: redeemedItems
          }, '*');
        }
      });
    }

    // Show notification to user
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 1001;
        animation: slideIn 0.3s ease;
        color: white;
        ${
          type === 'success' ? 'background: #4CAF50;' :
          type === 'warning' ? 'background: #ff9800;' :
          type === 'error' ? 'background: #f44336;' :
          'background: #2196F3;'
        }
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 3000);
    }

    // Test API connectivity on page load
    function testAPIConnectivity() {
      fetch('/api/get-money')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('‚úì API is working');
          }
        })
        .catch(error => {
          console.log('‚ö† API not available, will use localStorage:', error);
        });
    }

    // Test API on page load
    testAPIConnectivity();

    // Track this item as redeemed
    trackRedeemedItem(product);

    // Also try to update localStorage for the main window
    window.addEventListener('beforeunload', function() {
      // Ensure data is saved before leaving
      const redeemedItems = JSON.parse(localStorage.getItem('redeemedItems') || '[]');
      console.log('Page unloading, redeemed items saved:', redeemedItems);
    });
  </script>
</body>
</html>

