<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Redeemed Prize</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  /* --- KEEP ALL YOUR EXISTING CSS HERE --- */
</style>
</head>
<body>
<header>
  <a href="index.html" class="logo"><img src="productimages/k.png" alt="Circle K logo"></a>
</header>

<main>
  <section class="hero">
    <div class="plate-area">
      <div class="product-title" id="product-title"></div>
      <div class="product-sub" id="product-sub"></div>
      <img class="product-img" id="product-img" src="" alt="">
    </div>
  </section>

  <section class="barcode-card">
    <div class="redeemed-time" id="redeemed-at">--:-- - --.--.--</div>
    <div class="timer-badge" id="timer-badge">05:00</div>
    <img id="barcode-img" class="barcode-img" src="" alt="">
    <div class="code-text" id="code-text">000000000000</div>
  </section>
</main>

<script>
const params = new URLSearchParams(window.location.search);
const product = (params.get('product') || 'chips').toLowerCase();
const title = params.get('title') || 'Free Circle K Chips';
const sub = params.get('sub') || '(Any flavour, 66 g)';
const img = params.get('img') || 'productimages/chips.png';

document.getElementById('product-title').textContent = title;
document.getElementById('product-sub').textContent = sub;
document.getElementById('product-img').src = img;
document.getElementById('product-img').alt = title;

// Redeemed timestamp
function formatRedeemed() {
  const now = new Date();
  return `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')} - ${String(now.getDate()).padStart(2,'0')}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getFullYear()).slice(-2)}`;
}
document.getElementById('redeemed-at').textContent = formatRedeemed();

// Timer 5 min countdown
const badge = document.getElementById('timer-badge');
const badgeEnd = Date.now() + 5*60*1000;
function tickBadge(){
  const t = Math.max(0, Math.floor((badgeEnd - Date.now())/1000));
  badge.textContent = `${String(Math.floor(t/60)).padStart(2,'0')}:${String(t%60).padStart(2,'0')}`;
}
tickBadge();
setInterval(tickBadge, 1000);

// Barcode setup
const productCodes = {
  chips: '078302648190',
  candy: '045678123456', 
  alani: '012345678901',
  arizona: '067890123450',
  froster: '089012345678'
};
document.getElementById('code-text').textContent = productCodes[product] || '000000000000';
const barcodeImg = document.getElementById('barcode-img');
barcodeImg.src = `barcodes/${product}barcode.png`;
barcodeImg.onerror = () => { barcodeImg.style.display = 'none'; };

// Redeemed item tracking
function trackRedeemedItem(product) {
  console.log('Tracking redeemed item:', product);
  
  fetch('/api/add-money', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ product })
  })
  .then(async response => {
    let data;
    try { data = await response.json(); }
    catch(err) {
      console.log('Invalid JSON from API, falling back to localStorage.');
      data = null;
    }

    if (data && data.success) {
      console.log('Item tracked via API:', product, 'Total saved:', data.totalSaved);
    } else {
      // fallback to localStorage
      const key = `redemptionCount_${product}`;
      const count = parseInt(localStorage.getItem(key) || '0') + 1;
      localStorage.setItem(key, count);
      const redeemed = JSON.parse(localStorage.getItem('redeemedItems') || '[]');
      if (!redeemed.includes(product)) redeemed.push(product);
      localStorage.setItem('redeemedItems', JSON.stringify(redeemed));
      console.log('Item redeemed via localStorage:', product, 'Count:', count, 'Items:', redeemed);
    }
  })
  .catch(err => {
    console.log('Fetch failed, using localStorage:', err);
    const key = `redemptionCount_${product}`;
    const count = parseInt(localStorage.getItem(key) || '0') + 1;
    localStorage.setItem(key, count);
    const redeemed = JSON.parse(localStorage.getItem('redeemedItems') || '[]');
    if (!redeemed.includes(product)) redeemed.push(product);
    localStorage.setItem('redeemedItems', JSON.stringify(redeemed));
    console.log('Item redeemed via localStorage:', product, 'Count:', count, 'Items:', redeemed);
  });
}

trackRedeemedItem(product);

// Notify parent window to update counter
if (window.opener) {
  window.opener.postMessage({ type: 'itemRedeemed', product }, '*');
}

// Save localStorage on unload
window.addEventListener('beforeunload', () => {
  const redeemed = JSON.parse(localStorage.getItem('redeemedItems') || '[]');
  console.log('Page unloading, redeemed items saved:', redeemed);
});
</script>
</body>
</html>
